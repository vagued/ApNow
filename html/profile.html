<DOCTYPE! html>
<html>
    <head>
    	<meta charset="UTF-8">
    	<title>Profile</title>
    	<link rel="stylesheet" href="../css/style.css">

    </head>

    <body id = "def">
    	<header>
    	   <div class = "navbar">
		            <a href = "homepage.html" id = "logo"> <img src = "../img/logo.png"> </a>
                	<a href = "homepage.html?logout" id = "logout">Log out</a>
                	<a href = " " id = "help">Help!</a>
                	<a href = "uploadform.html" id = "upload">Upload</a>
					<div id="navbar2"></div>
           </div>
    	</header>

	   <div class = "main">
		   <div class="profile">
         <img id = "pic" src="http://image005.flaticon.com/1/svg/145/145867.svg" />
         <h1 id = "username"> Username</h1>
         <h2 id = "firstname"> First name: John </h2>
         <h2 id = "lastname"> Last name: Doe</h2>
         <h2 id = "email"> Email: example@domain.com</h2>
			   <div id = "profile-navbar">
           <button onclick = "showHistory();" > History </button>
           <button onclick = "showUpcoming();" > Upcoming </button>
           <button onclick = "showClientApartments();" > My Apartments </button>

		   <p id="history"></p>
		   <p id="upcoming"></p>
		   <p id="myapartments"></p>

	      </div>
         </div>
       </div>

       <script>
      	   document.getElementById("pic").setAttribute("src",'../img/clients/' + sessionStorage.idClient + '.' + sessionStorage.extension);
             document.getElementById("username").innerHTML = sessionStorage.username;
             document.getElementById("firstname").innerHTML =sessionStorage.firstName;
             document.getElementById("lastname").innerHTML = sessionStorage.lastName;
      	   document.getElementById("email").innerHTML = sessionStorage.email;
        </script>

         <script>
    		   function showHistory() {

  		       var xmlhttp, apartments, count, out = "";

    			   xmlhttp = new XMLHttpRequest();

    			   xmlhttp.onreadystatechange = function()
             {

    				   if (this.readyState == 4 && this.status == 200)
               {
                 apartments = JSON.parse(this.responseText);
                 out = "<table>";

                 count=1;

                   for(x in apartments)
                   {
                       out +=
                         "<tr><td>" +
                             apartments[x].title +
                        "</td><td>" +
                             apartments[x].checkin +
                        "</td><td>" +
                             apartments[x].checkout +
                        "</td><td>";

                        if(apartments[x].rating==null)
                        {
                          out +=

                             '<span class="fa fa-star" id="1" onclick="rate(' +
                                + apartments[x].idrenting + ', this.id);"></span>' +
                            '<span class="fa fa-star" id="2" onclick="rate(' +
                                 + apartments[x].idrenting + ', this.id);"></span>' +
                             '<span class="fa fa-star" id="3" onclick="rate(' +
                                + apartments[x].idrenting + ', this.id);"></span>' +
                            '<span class="fa fa-star" id="4" onclick="rate(' +
                                 + apartments[x].idrenting + ', this.id);"></span>' +
                             '<span class="fa fa-star" id="5" onclick="rate(' +
                                + apartments[x].idrenting + ', this.id);"></span>' +

                            '<textarea id=' + count + '></textarea>' +

                            '<button value=' + count + ' id="' + count + 'b" onclick="insertRating(this.id);">Press to submit rating</button>';

                            count++;
                        }
                        else
                        {
                          out += apartments[x].rating + " stars";
                        }

                        out += '</td></tr>';
                    }

                 out += "</table>";

               document.getElementById("history").innerHTML = out;
    				}
    			};
    				xmlhttp.open("GET", "../php/return-history.php?q=" + sessionStorage.idClient, true);
  			    xmlhttp.send();
  		   }

        //  for(i=1;i<=count;i++)
        //  {
        //    document.getElementById(i).input.addEventListener("keyup", function(event)
        //    {
        //         event.preventDefault();
        //         if (event.keyCode === 13) {
        //           document.getElemendById.(i+"b").click();
        //         }
        //     };
        // }

         function rate(idrenting,rating)
         {
           sessionStorage.idrenting = idrenting;
           sessionStorage.rating = rating;
         }

          function insertRating(i)
          {
            if(sessionStorage.rating != null)
            {
              var id=document.getElementById(i).value;
              var comment = document.getElementById(id).value;
              console.log(id);

              var xmlhttp, apartment;

         			xmlhttp = new XMLHttpRequest();

         			xmlhttp.onreadystatechange = function()
               {
          			  if (this.readyState == 4 && this.status == 200)
                    if(this.responseText==0)
                    {
                      alert("Some error");
                    }
                    else
                    {
                      alert("OK");
                    }
               };

              xmlhttp.open("GET", "../php/submit-rating.php?idr=" + sessionStorage.idrenting
              + "&rating=" + sessionStorage.rating
              + "&comment=" + comment, true);
       			  xmlhttp.send();

              sessionStorage.removeItem("rating");
              sessionStorage.removeItem("idrenting");

              document.getElementById(i).disabled = true;
          }
          else
          {
            alert("Please select a rating first");
          }
        }

      </script>


	   <div class="footer">
           <div class="container">
               <p>&copy; ApNow 2018</p>
           </div>
      </div>

</body></html></DOCTYPE>
